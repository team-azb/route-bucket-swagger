openapi: 3.0.3
info:
  title: RouteBucketBackend
  description: RouteBucketBackend
  version: 0.1.0
servers:
  - url: 'http://localhost:8080/'
    description: development
tags:
  - name: route
    description: ルートに関するエンドポイントたち
  - name: user
    description: ユーザーに関するエンドポイントたち
paths:
  /routes/:
    get:
      operationId: routesGetAll
      summary: 全Route一覧
      tags:
        - route
      responses:
        '200':
          description: OK
          content:
            application/json:
              schema:
                type: object
                properties:
                  routes:
                    type: array
                    items:
                      $ref: '#/components/schemas/RouteInfo'
                    example:
                      - id: kB61aMhc4I_
                        name: mock_sample
                required:
                  - routes
      description: 全`Route`の`RouteInfo`を一覧で返す
    post:
      operationId: routesPost
      summary: Routeの作成
      tags:
        - route
      description: |
        指定した名前のRouteを作成し、そのidを返す
      requestBody:
        description: Routeの情報
        required: true
        content:
          application/json:
            schema:
              type: object
              description: Route作成リクエスト
              required:
                - name
              properties:
                name:
                  type: string
                  maxLength: 50
                  description: Routeの名前
      responses:
        '201':
          description: created
          content:
            application/json:
              schema:
                type: object
                description: Route作成レスポンス
                properties:
                  id:
                    $ref: '#/components/schemas/RouteId'
                required:
                  - id
  '/routes/{id}':
    get:
      operationId: routesGet
      summary: Routeの取得
      tags:
        - route
      description: |
        指定したRouteの情報を取得する
      responses:
        '200':
          description: ok
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Route'
              example:
                id: kB61aMhc4I_
                name: mock_sample
                waypoints:
                  - latitude: 35.68136
                    longitude: 139.75876
                  - latitude: 35.69055
                    longitude: 139.7568
                segments:
                  - points:
                      - latitude: 35.68136
                        longitude: 139.75876
                        elevation: 7
                        distance_from_start: 0
                      - latitude: 35.68244
                        longitude: 139.75945
                        elevation: 0
                        distance_from_start: 135.29845221622904
                      - latitude: 35.68275
                        longitude: 139.75966
                        elevation: -12
                        distance_from_start: 174.64283262126588
                      - latitude: 35.68314
                        longitude: 139.75991
                        elevation: -5
                        distance_from_start: 223.53520415689425
                      - latitude: 35.6832
                        longitude: 139.75986
                        elevation: -5
                        distance_from_start: 235.0378642930681
                      - latitude: 35.68452
                        longitude: 139.76027
                        elevation: 1
                        distance_from_start: 387.91297063867233
                      - latitude: 35.68481
                        longitude: 139.7604
                        elevation: 0
                        distance_from_start: 422.24716811243513
                      - latitude: 35.68496
                        longitude: 139.7605
                        elevation: 5
                        distance_from_start: 441.2240245995616
                      - latitude: 35.68523
                        longitude: 139.76072
                        elevation: 5
                        distance_from_start: 477.23739202415607
                      - latitude: 35.68532
                        longitude: 139.76082
                        elevation: 5
                        distance_from_start: 490.9080235469514
                      - latitude: 35.6856
                        longitude: 139.76095
                        elevation: 6
                        distance_from_start: 524.214475013159
                      - latitude: 35.68569
                        longitude: 139.76099
                        elevation: 6
                        distance_from_start: 534.8608965088586
                      - latitude: 35.68576
                        longitude: 139.76102
                        elevation: 6
                        distance_from_start: 543.1174461489453
                      - latitude: 35.68584
                        longitude: 139.76106
                        elevation: 6
                        distance_from_start: 552.7186395786945
                      - latitude: 35.68713
                        longitude: 139.7614
                        elevation: 12
                        distance_from_start: 699.460287920067
                      - latitude: 35.68731
                        longitude: 139.76143
                        elevation: 12
                        distance_from_start: 719.8356893322001
                      - latitude: 35.68833
                        longitude: 139.76102
                        elevation: -4
                        distance_from_start: 839.146113765254
                      - latitude: 35.6892
                        longitude: 139.76076
                        elevation: 1
                        distance_from_start: 938.7117673516411
                      - latitude: 35.68939
                        longitude: 139.76053
                        elevation: 1
                        distance_from_start: 968.5363238601359
                      - latitude: 35.68996
                        longitude: 139.75983
                        elevation: 20
                        distance_from_start: 1058.0709003556071
                      - latitude: 35.68999
                        longitude: 139.75974
                        elevation: 20
                        distance_from_start: 1066.9634531124427
                      - latitude: 35.69021
                        longitude: 139.75869
                        elevation: 14
                        distance_from_start: 1164.899981198707
                      - latitude: 35.69028
                        longitude: 139.75821
                        elevation: 14
                        distance_from_start: 1208.9694613796746
                      - latitude: 35.69054
                        longitude: 139.75667
                        elevation: 16
                        distance_from_start: 1358.3763482720174
                      - latitude: 35.69055
                        longitude: 139.7568
                        elevation: 16
                        distance_from_start: 1370.582718193045
                elevation_gain: 302
                total_distance: 6188.845447778645
                bounding_box:
                  min_coord:
                    longitude: 139.7568
                    latitude: 35.68136
                  max_coord:
                    longitude: 139.76143
                    latitude: 35.69055
        '404':
          description: |
            対応するRouteが存在しない場合
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
    delete:
      operationId: routesDelete
      summary: Routeの削除
      tags:
        - route
      responses:
        '200':
          description: ok
        '404':
          description: |
            対応するRouteが存在しない場合
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
    parameters:
      - in: path
        name: id
        description: RouteのID
        required: true
        schema:
          type: string
  '/routes/{id}/gpx/':
    parameters:
      - $ref: '#/components/parameters/route_id'
    get:
      summary: RouteのGPX出力
      tags:
        - route
      responses:
        '200':
          description: |-
            OK

            `Route`を表すGPXファイルを返す
            GPXは少なくともGarmin Connectで動作確認済み
            スキーマは省略
          content:
            application/gpx+xml:
              schema:
                type: object
                properties: {}
      operationId: get-routes-id-gpx
      description: ''
      parameters: []
  '/routes/{id}/rename/':
    patch:
      operationId: routesRename
      summary: Routeの名前変更
      description: |
        指定したRouteの名前を変更する
      tags:
        - route
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              description: Route改名リクエスト
              required:
                - name
              properties:
                name:
                  type: string
                  description: 変更したい名前
      responses:
        '200':
          description: 更新成功
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/RouteInfo'
        '404':
          description: |
            対応するRouteが存在しない場合
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
    parameters:
      - $ref: '#/components/parameters/route_id'
  '/routes/{id}/add/{pos}':
    patch:
      operationId: routesAdd
      summary: 新たな点の追加
      tags:
        - route
      description: |
        指定したRouteのpos番目の位置に新たな点を追加する
      responses:
        '200':
          $ref: '#/components/responses/RouteEditResponse'
        '400':
          description: |
            更新失敗、posの値がRouteの長さより長い場合、`mode`が予期しない値の場合など
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
        '404':
          description: |
            対応するRouteが存在しない場合
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
      requestBody:
        $ref: '#/components/requestBodies/RouteEditWithNewPointRequest'
    parameters:
      - $ref: '#/components/parameters/route_id'
      - $ref: '#/components/parameters/pos'
  '/routes/{id}/remove/{pos}':
    patch:
      operationId: routesRemove
      summary: 点の削除
      tags:
        - route
      description: |
        指定したRouteのpos番目の点を削除する
      responses:
        '200':
          $ref: '#/components/responses/RouteEditResponse'
        '400':
          description: |
            更新失敗、posの値がRouteの長さより長い場合、`mode`が予期しない値の場合など
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
        '404':
          description: |
            対応するRouteが存在しない場合
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
      requestBody:
        content:
          application/json:
            schema:
              type: object
              properties:
                mode:
                  $ref: '#/components/schemas/DrawingMode'
              required:
                - mode
    parameters:
      - $ref: '#/components/parameters/route_id'
      - $ref: '#/components/parameters/pos'
  '/routes/{id}/move/{pos}':
    patch:
      operationId: routesMove
      summary: 点の座標の変更
      description: route_idに対応するRouteのpos番目の点の座標を変更する
      tags:
        - route
      responses:
        '200':
          $ref: '#/components/responses/RouteEditResponse'
        '400':
          description: |
            更新失敗、posの値がRouteの長さ以上の場合、`mode`が予期しない値の場合など
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
        '404':
          description: |
            対応するRouteが存在しない場合
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
      requestBody:
        $ref: '#/components/requestBodies/RouteEditWithNewPointRequest'
    parameters:
      - $ref: '#/components/parameters/route_id'
      - $ref: '#/components/parameters/pos'
  '/routes/{id}/clear/':
    patch:
      operationId: routesClear
      summary: 点のクリア
      tags:
        - route
      description: |
        指定したRouteの全ての点を削除する
      responses:
        '200':
          $ref: '#/components/responses/RouteEditResponse'
        '404':
          description: |
            対応するRouteが存在しない場合
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
    parameters:
      - $ref: '#/components/parameters/route_id'
  '/routes/{id}/redo/':
    patch:
      operationId: routesRedo
      summary: 操作を進む
      tags:
        - route
      description: |
        指定したRouteの操作を一つ進める
      responses:
        '200':
          $ref: '#/components/responses/RouteEditResponse'
        '400':
          description: |
            更新失敗、これ以上redoできない場合など
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
        '404':
          description: |
            対応するRouteが存在しない場合
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
    parameters:
      - $ref: '#/components/parameters/route_id'
  '/routes/{id}/undo/':
    patch:
      operationId: routesUndo
      summary: 操作を戻る
      tags:
        - route
      description: |
        指定したRouteの操作を一つ戻す
      responses:
        '200':
          $ref: '#/components/responses/RouteEditResponse'
        '400':
          description: |
            更新失敗、これ以上undoできない場合など
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
        '404':
          description: |
            対応するRouteが存在しない場合
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
    parameters:
      - $ref: '#/components/parameters/route_id'
  /users/:
    post:
      summary: Userの作成
      operationId: post-users
      responses:
        '200':
          description: OK
          content:
            application/json:
              schema:
                type: object
                properties:
                  id:
                    $ref: '#/components/schemas/UserId'
                required:
                  - id
        '400':
          description: |-
            バリデーションに引っかかった場合
            * 名前の長さ
            * id, email, passwordの形式
            など
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
      tags:
        - user
      description: 与えられたbodyから`User`を作成し、そのidを返す
      requestBody:
        content:
          application/json:
            schema:
              type: object
              properties:
                id:
                  $ref: '#/components/schemas/UserId'
                name:
                  type: string
                  minLength: 1
                  maxLength: 50
                  description: Userの表示名
                email:
                  type: string
                  format: email
                  description: Userのemail
                gender:
                  type: string
                  enum:
                    - male
                    - female
                    - others
                  description: 性別
                  default: others
                birthdate:
                  type: string
                  format: date
                  description: 生年月日（未来の日付は指定不可）
                icon_url:
                  type: string
                  format: uri
                  description: アイコン画像のURL
                password:
                  type: string
                  description: アカウントのパスワード
                  minLength: 6
                password_confirmation:
                  type: string
                  description: パスワード確認用
                  minLength: 6
              required:
                - id
                - name
                - email
                - password
                - password_confirmation
            examples: {}
        description: Userの情報
components:
  schemas:
    Coordinate:
      title: Coordinate
      type: object
      properties:
        latitude:
          type: number
          minimum: -90
          maximum: 90
          format: double
          description: 緯度
        longitude:
          type: number
          minimum: -180
          maximum: 180
          format: double
          description: 経度
      required:
        - latitude
        - longitude
      description: 地球上の点を表す座標
      x-tags:
        - route
    CoordinateVerbose:
      title: CoordinateVerbose
      type: object
      description: ルート上の点を表す座標
      properties:
        latitude:
          type: number
          minimum: -90
          maximum: 90
          format: double
          description: 緯度
        longitude:
          type: number
          minimum: -180
          maximum: 180
          format: double
          description: 経度
        elevation:
          type: integer
          format: int32
          minimum: 0
        distance_from_start:
          type: number
          format: double
          minimum: 0
      required:
        - latitude
        - longitude
        - distance_from_start
      x-tags:
        - route
    BoundingBox:
      title: BoundingBox
      type: object
      description: |-
        Routeを囲むバウンディングボックス
        フロントでの地図表示に用いる
      properties:
        min_coord:
          $ref: '#/components/schemas/Coordinate'
        max_coord:
          $ref: '#/components/schemas/Coordinate'
      required:
        - min_coord
        - max_coord
    Segment:
      type: object
      description: waypointに挟まれた一つの区間に対し、補間を行った上で標高を付与した配列
      properties:
        points:
          type: array
          items:
            $ref: '#/components/schemas/CoordinateVerbose'
      required:
        - points
      x-tags:
        - route
    Polyline:
      type: string
      description: |
        Polyline形式で表現された座標のリスト
        参考：https://developers.google.com/maps/documentation/utilities/polylinealgorithm
      example: _p~iF~ps|U_ulLnnqC_mqNvxq`@
      x-tags:
        - route
    DrawingMode:
      type: string
      title: DrawingMode
      description: |-
        `Segment`を補完するときのモード
        * `follow_road`: 道に沿う
        * `freehand`: フリーハンド
      enum:
        - follow_road
        - freehand
    RouteId:
      type: string
      title: RouteId
      pattern: '^[A-Za-z0-9_-]+'
      minLength: 11
      maxLength: 11
      description: '`Route`のID'
      x-tags:
        - route
      x-examples: {}
      example: 2baY2o3zfGP
    RouteInfo:
      type: object
      description: Route
      x-tags:
        - route
      properties:
        id:
          $ref: '#/components/schemas/RouteId'
        name:
          type: string
          maxLength: 50
          description: ルートの名前
      required:
        - id
        - name
    Route:
      type: object
      description: |-
        `Polyline`付きの`Route`
        `Route`が空の場合のみ`BoundingBox`を持たない
      x-tags:
        - route
      properties:
        id:
          $ref: '#/components/schemas/RouteId'
        name:
          type: string
          maxLength: 50
          description: ルートの名前
        waypoints:
          type: array
          description: ユーザーの入力した点の配列
          items:
            $ref: '#/components/schemas/Coordinate'
        segments:
          type: array
          description: 各waypointsの間のSegmentたち
          items:
            $ref: '#/components/schemas/Segment'
        elevation_gain:
          type: integer
          description: 獲得標高
          minimum: 0
          format: int32
        total_distance:
          type: number
          description: ルートの総距離
          minimum: 0
          format: double
        bounding_box:
          $ref: '#/components/schemas/BoundingBox'
      required:
        - id
        - name
        - waypoints
        - segments
        - elevation_gain
        - total_distance
    UserId:
      type: string
      title: UserId
      description: '`User`のID'
      pattern: '^[a-zA-Z0-9]([a-zA-Z0-9]?|[\-]?([a-zA-Z0-9])){0,38}$'
    Error:
      type: object
      description: Error
      required:
        - message
      properties:
        message:
          type: string
          description: エラー内容
      title: ''
  parameters:
    pos:
      name: pos
      in: path
      required: true
      schema:
        type: integer
      description: 操作する点の位置
    route_id:
      name: id
      in: path
      required: true
      schema:
        type: string
        minLength: 11
        maxLength: 11
        pattern: '^[A-Za-z0-9_-]+'
      description: ルートのID
  responses:
    RouteEditResponse:
      description: '`Route`編集系のエンドポイントで返すレスポンス'
      content:
        application/json:
          schema:
            type: object
            properties:
              waypoints:
                type: array
                description: ユーザーの入力した点の配列
                items:
                  $ref: '#/components/schemas/Coordinate'
              segments:
                type: array
                description: 各waypointsの間のSegmentたち
                items:
                  $ref: '#/components/schemas/Segment'
              elevation_gain:
                type: integer
                description: 獲得標高
                minimum: 0
                format: int32
              total_distance:
                type: number
                description: ルートの総距離
                minimum: 0
                format: double
            required:
              - waypoints
              - segments
              - elevation_gain
              - total_distance
  examples: {}
  requestBodies:
    RouteEditWithNewPointRequest:
      content:
        application/json:
          schema:
            type: object
            properties:
              coord:
                $ref: '#/components/schemas/Coordinate'
              mode:
                $ref: '#/components/schemas/DrawingMode'
            required:
              - coord
              - mode
      description: addやmoveのように、新たな座標を提供するリクエスト
